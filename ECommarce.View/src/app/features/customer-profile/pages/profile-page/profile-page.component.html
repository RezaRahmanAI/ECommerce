<div class="container mx-auto px-4 py-8 max-w-4xl">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex justify-center py-12">
    <div
      class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"
    ></div>
  </div>

  <ng-container *ngIf="!isLoading">
    <!-- Login / Phone Entry Step -->
    <div
      *ngIf="!(phone$ | async)"
      class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8"
    >
      <div class="text-center mb-8">
        <div
          class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 text-primary mb-4"
        >
          <lucide-icon [img]="icons.User" class="w-8 h-8"></lucide-icon>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
          Customer Access
        </h2>
        <p class="text-gray-500 mt-2">
          Enter your phone number to access your orders and profile.
        </p>
      </div>

      <form [formGroup]="loginForm" (ngSubmit)="login()" class="space-y-6">
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Phone Number</label
          >
          <input
            type="tel"
            formControlName="phone"
            class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent transition-colors"
            placeholder="e.g. 01700000000"
          />
          <p
            *ngIf="
              loginForm.get('phone')?.touched && loginForm.get('phone')?.invalid
            "
            class="text-red-500 text-sm mt-1"
          >
            Please enter a valid phone number
          </p>
        </div>

        <button
          type="submit"
          [disabled]="loginForm.invalid || isSubmitting"
          class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {{ isSubmitting ? "Checking..." : "Access Profile" }}
        </button>
      </form>
    </div>

    <!-- Profile Dashboard -->
    <div *ngIf="phone$ | async" class="space-y-8">
      <!-- Header -->
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
            My Profile
          </h1>
          <p class="text-gray-500 mt-1">
            Manage your information and view orders
          </p>
        </div>
        <button
          (click)="logout()"
          class="px-4 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors"
        >
          Sign Out
        </button>
      </div>

      <div class="grid md:grid-cols-3 gap-8">
        <!-- Sidebar / Profile Info -->
        <div class="md:col-span-1 space-y-6">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
            <h3
              class="text-lg font-semibold mb-4 text-gray-900 dark:text-white"
            >
              Personal Info
            </h3>

            <form
              [formGroup]="profileForm"
              (ngSubmit)="updateProfile()"
              class="space-y-4"
            >
              <div>
                <label
                  class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1"
                  >Phone</label
                >
                <div
                  class="text-lg font-medium text-gray-900 dark:text-gray-200"
                >
                  {{ profileForm.get("phone")?.value }}
                </div>
              </div>

              <div>
                <label
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                  >Full Name</label
                >
                <input
                  type="text"
                  formControlName="name"
                  class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent text-sm"
                />
              </div>

              <div>
                <label
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                  >Address</label
                >
                <textarea
                  formControlName="address"
                  rows="3"
                  class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent text-sm resize-none"
                ></textarea>
              </div>

              <div>
                <label
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                  >Delivery Details</label
                >
                <textarea
                  formControlName="deliveryDetails"
                  rows="2"
                  class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent text-sm resize-none"
                  placeholder="Optional notes for delivery"
                ></textarea>
              </div>

              <button
                type="submit"
                [disabled]="
                  profileForm.invalid || isSubmitting || profileForm.pristine
                "
                class="w-full mt-2 bg-primary text-white py-2 rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {{ isSubmitting ? "Saving..." : "Update Details" }}
              </button>

              <p
                *ngIf="saveSuccess"
                class="text-green-600 text-xs text-center font-medium mt-2"
              >
                Profile updated successfully!
              </p>
            </form>
          </div>
        </div>

        <!-- Main Content / Stats & Orders -->
        <div class="md:col-span-2 space-y-6">
          <!-- Stats -->
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
              <div class="text-sm text-gray-500 mb-1">Total Orders</div>
              <div class="text-3xl font-bold text-primary">
                {{ orders.length }}
              </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6">
              <div class="text-sm text-gray-500 mb-1">Total Spent</div>
              <div class="text-3xl font-bold text-accent">
                ৳{{ totalSpent }}
              </div>
            </div>
          </div>

          <!-- Recent Orders -->
          <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden"
          >
            <div
              class="px-6 py-4 border-b border-gray-100 dark:border-gray-700"
            >
              <h3 class="font-semibold text-gray-900 dark:text-white">
                Order History
              </h3>
            </div>

            <div
              *ngIf="orders.length === 0"
              class="p-8 text-center text-gray-500"
            >
              No orders found. Start shopping!
            </div>

            <div class="divide-y divide-gray-100 dark:divide-gray-700">
              <div
                *ngFor="let order of orders"
                class="p-6 hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors"
              >
                <div class="flex items-center justify-between mb-4">
                  <div>
                    <div
                      class="text-sm font-medium text-gray-900 dark:text-white"
                    >
                      Order #{{ order.id }}
                    </div>
                    <div class="text-xs text-gray-500">
                      {{ order.createdAt | date: "mediumDate" }}
                    </div>
                  </div>
                  <div
                    class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300"
                  >
                    {{ order.status }}
                  </div>
                </div>

                <div class="flex items-center gap-4 overflow-x-auto pb-2">
                  <div
                    *ngFor="let item of order.items"
                    class="flex-shrink-0 relative group"
                  >
                    <img
                      [src]="imageUrlService.getImageUrl(item.imageUrl)"
                      [alt]="item.productName"
                      class="w-16 h-16 object-cover rounded-md border border-gray-200 dark:border-gray-700"
                    />
                    <span
                      class="absolute -top-2 -right-2 bg-gray-900 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full"
                    >
                      {{ item.quantity }}
                    </span>
                  </div>
                </div>

                <div class="flex items-center justify-between mt-4 text-sm">
                  <span class="text-gray-500"
                    >{{ order.items.length }} Items</span
                  >
                  <span class="font-bold text-gray-900 dark:text-white"
                    >Total: ৳{{ order.total }}</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>
